#include "http_util.h"
#include <string.h>
#include <rtthread.h>

#define BURSIZE 1024

static int hex2dec(char c)
{
    if ('0' <= c && c <= '9') {
            return c - '0';
    } else if ('a' <= c && c <= 'f') {
            return c - 'a' + 10;
    } else if ('A' <= c && c <= 'F') {
            return c - 'A' + 10;
    } else {
            return -1;
    }
}

static char dec2hex(short int c)
{
    if (0 <= c && c <= 9) {
            return c + '0';
    } else if (10 <= c && c <= 15) {
            return c + 'A' - 10;
    } else {
            return (char)-1;
    }
}


void http_urlencode(char *url)
{
    int i = 0;
    int len = strlen(url);
    int res_len = 0;
    char *res = rt_calloc(1, BURSIZE);
    for (i = 0; i < len; ++i) {
        char c = url[i];
        if (('0' <= c && c <= '9') ||
                        ('a' <= c && c <= 'z') ||
                        ('A' <= c && c <= 'Z') || c == '/' || c == '.') {
                res[res_len++] = c;
        } else {
                int j = (short int)c;
                if (j < 0)
                        j += 256;
                int i1, i0;
                i1 = j / 16;
                i0 = j - i1 * 16;
                res[res_len++] = '%';
                res[res_len++] = dec2hex(i1);
                res[res_len++] = dec2hex(i0);
        }
    }

    res[res_len] = '\0';
    strcpy(url, res);
    rt_free(res);
}

void http_urldecode(char *url)
{
    int i = 0;
    int len = strlen(url);
    int res_len = 0;
    char *res = rt_calloc(1, BURSIZE);
    for (i = 0; i < len; ++i) {
        char c = url[i];
        if (c != '%') {
                res[res_len++] = c;
        } else {
                char c1 = url[++i];
                char c0 = url[++i];
                int num = 0;
                num = hex2dec(c1) * 16 + hex2dec(c0);
                res[res_len++] = num;
        }
    }
    res[res_len] = '\0';
    strcpy(url, res);
    rt_free(res);
}
